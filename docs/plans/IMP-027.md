# IMP-027 — Intraday microstructure stores (stocks + options): trades, quotes, bars

- **Status:** draft
- **Effort:** L
- **Alpha potential:** Very High

## Summary
Add a **microstructure data layer** that can download and persist intraday:
- stock trades + quotes + bars
- option trades + quotes + bars (within Alpaca lookback limits)

This enables new features that are currently impossible with daily-only Yahoo snapshots:
- empirical spread / slippage modeling
- quote staleness analysis by time-of-day
- intraday realized volatility and “vol-of-vol”
- time-weighted liquidity scoring
- better backtests (execution realism)

## Goals
- Define durable, append-friendly stores for intraday datasets (CSV.gz + meta).
- Implement Alpaca fetchers for:
  - stock bars (1Min/5Min)
  - stock quotes/trades (optional at first)
  - option bars (1Min/5Min)
  - option quotes/trades (best-effort; be aware of retention limits)
- Provide at least one CLI entry point to pull + persist intraday data for a set of symbols.

## Non-goals
- Real-time streaming capture (IMP-029).
- Building new analytics on top (keep this IMP focused on data acquisition + storage).
- Long-horizon option trades history (provider limits may prevent it; this is about ongoing capture).

## User-facing changes
- New CLI command group (proposed): `options-helper intraday ...`
  - `intraday pull-stocks --symbols ... --date ... --timeframe 1Min`
  - `intraday pull-options --underlyings ... --date ... --timeframe 1Min --expiries ...`
- New data directories:
  - `data/intraday/stocks/bars/1Min/<SYMBOL>/<YYYY-MM-DD>.csv.gz`
  - `data/intraday/options/bars/1Min/<CONTRACT>/<YYYY-MM-DD>.csv.gz`
  - plus `*.meta.json`

## Design
### Storage format
- Use **CSV.gz** for simplicity (no new dependencies).
- Each partition is “one symbol (or contract) × one day × one dataset”.
- Metadata JSON per partition includes:
  - schema_version
  - provider name/version
  - request params (timeframe, feed, start/end, limit)
  - row counts and coverage timestamps

### Schemas
Stocks bars (normalized):
- `timestamp`, `open`, `high`, `low`, `close`, `volume`, `trade_count` (if available), `vwap` (if available)

Options bars:
- same as above, keyed by `contractSymbol`

Quotes/trades schemas (normalized, additive):
- Quotes: `timestamp`, `bid_price`, `ask_price`, `bid_size`, `ask_size`, `exchange` (if present)
- Trades: `timestamp`, `price`, `size`, `exchange`, `conditions` (if present)

### Pull strategy
- For options, prefer bars first (much smaller than quotes/trades).
- Quotes/trades can be toggled off by default to avoid massive downloads.

## Implementation plan
### Step 1 — Add generic intraday store
**Files:**
- `options_helper/data/intraday_store.py` (new)

**Work:**
- `IntradayStore(root_dir: Path)`
  - `save_partition(kind, dataset, timeframe, symbol, day, df, meta)`
  - `load_partition(...)`
  - helpers for pathing and meta schema versioning

### Step 2 — Add Alpaca fetchers
**Files:**
- `options_helper/data/alpaca_client.py`

**Work:**
- Add methods:
  - `get_stock_bars_intraday(symbols, *, day, timeframe, feed) -> pd.DataFrame`
  - `get_option_bars_intraday(contracts, *, day, timeframe, feed) -> pd.DataFrame`
  - (optional) `get_stock_quotes(...)`, `get_stock_trades(...)`, `get_option_quotes(...)`, `get_option_trades(...)`
- Normalize timestamps and columns into schemas above.

### Step 3 — Add CLI command(s)
**Files:**
- `options_helper/cli.py`

**Work:**
- Add a new Typer command group `intraday`.
- Implement at least:
  - `pull_stocks_bars`
  - `pull_options_bars` (accept underlyings and expand to contracts via IMP-023 cache)

### Step 4 — Add cron-friendly script
**Files:**
- `scripts/cron_intraday_capture.sh` (new, optional)
- `scripts/install_cron_intraday_capture.sh` (new, optional)

**Work:**
- Provide an example schedule to build a rolling intraday dataset.

## Tests
- `tests/intraday/test_intraday_store_roundtrip.py` (new)
- `tests/providers/test_alpaca_intraday_bars_mapping.py` (new)
  - mocking SDK responses and verifying schema + partition writes.

## Acceptance criteria
- Can pull and persist 1Min bars for a small list of stock symbols for a single day.
- Can pull and persist 1Min bars for a set of option contracts (derived from an underlying).
- Stored partitions are readable back into DataFrames with correct dtypes and timestamps.
