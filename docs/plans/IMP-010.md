# IMP-010 — Multi-leg support (verticals/calendars/diagonals) + roll-plans

- **Status:** done
- **Effort:** XL
- **Alpha potential:** Med–High

## Summary
Add first-class support for multi-leg option positions (spreads and calendars) in the portfolio model, analysis, and roll planning.

This unlocks structures that fit IV/skew regimes and risk limits better than single-leg longs, but it is a large build.

## Goals
- Extend portfolio schema to represent a position as a list of legs.
- Support valuing a multi-leg position (best-effort marks for each leg) and computing basic combined greeks.
- Add roll planning that can propose:
  - rolling a single leg
  - rolling the entire structure to new strikes/expiries
- Ensure liquidity/spread gating works per-leg and at structure level.

## Non-goals (v1)
- Complex payoff diagrams in the UI (can be added later).
- Assignment and early exercise modeling.

## User-facing changes
- `portfolio.json` schema changes:
  - positions may be `single` or `multi`.
  - a multi-leg position contains `legs: [{side, option_type, expiry, strike, contracts, ratio}]`.
- New CLI flows:
  - `add-position` can accept multiple `--leg` flags OR a separate `add-spread` command.

## Design
### Data model
- `Position` becomes either:
  - `SingleLegPosition` (current)
  - `MultiLegPosition` (new)
- A `Leg` has:
  - `symbol`, `expiry`, `strike`, `option_type`, `side` (long/short), `contracts`

### Valuation
- Net mark = sum(leg_mark * sign * contracts * 100)
- Spread-aware fills (IMP-001) should apply per leg.

### Roll planning
- For common structures:
  - vertical: keep expiry, shift strikes
  - calendar: roll front leg, keep back leg
  - diagonal: shift strike and expiry with constraints

## Implementation plan (phased)
### Phase 1 — Schema + basic valuation
**Files:**
- `options_helper/models.py`
- `options_helper/cli.py`

**Work:**
- Add new models and JSON parsing.
- Update `list` and `remove-position` to handle multi-leg.
- Update `analyze` to show per-leg marks + net.

### Phase 2 — Liquidity + risk
**Files:**
- `options_helper/analysis/options_liquidity.py`
- `options_helper/analysis/portfolio_risk.py` (from IMP-004)

**Work:**
- Evaluate liquidity per leg and overall.
- Add combined greek approximations.

### Phase 3 — Roll-plan for structures
**Files:**
- `options_helper/analysis/roll_plan.py`
- new `options_helper/analysis/roll_plan_multileg.py`

**Work:**
- Add roll candidate generation for verticals/calendars.

### Phase 4 — Tests + docs
**Files:**
- `tests/test_models.py`
- new multi-leg tests
- `docs/MULTI_LEG.md` (new)

## Acceptance criteria
- You can represent and analyze at least one vertical spread end-to-end.
- Roll-plan can propose at least one reasonable roll for that spread using snapshots.

## Implementation notes (v1)
- Multi-leg positions are supported in portfolio + analyze.
- `roll-plan` supports 2-leg same-expiry verticals only; calendars/diagonals deferred.
