# IMP-001 — Spread-aware contract selection everywhere

- **Status:** ready
- **Effort:** S
- **Alpha potential:** High

## Summary
Make contract selection and recommendations **execution-aware** by computing bid/ask spread (absolute + %) everywhere we rank, filter, or summarize contracts.
Surface “execution quality” alongside mark/OI/volume and downgrade confidence when spreads or quotes are missing.

## Goals
- Compute `spread` and `spread_pct` consistently across:
  - `research` idea generation
  - `roll-plan` candidate selection
  - position `analyze` / `advice` (warnings + confidence)
  - briefing/report artifacts
- Add a simple, explainable `execution_quality` label (e.g., `good/ok/bad/unknown`).
- Ensure all spread logic is **best-effort** (Yahoo often has 0 or missing bid/ask).

## Non-goals
- Modeling fills, order book depth, or smart order routing.
- Broker integration.

## User-facing changes
- New per-contract fields where applicable:
  - `spread`, `spread_pct`, `execution_quality`
- New gating/penalties:
  - configurable `max_spread_pct` (defaults conservative; reuse existing roll-plan default where possible)
- New warnings in `analyze`:
  - `missing_bid_ask`, `wide_spread` (quote staleness is handled more fully in IMP-013)

## Design
### Canonical spread calculation
- If `bid>0` and `ask>0`:
  - `spread = ask - bid`
  - `mid = (ask+bid)/2`
  - `spread_pct = spread / mid` (guard `mid>0`)
- Else: spread is `None` (unknown).

### Execution quality label (v1)
- `unknown`: missing/zero bid/ask or invalid quote
- `good`: `spread_pct <= 0.15`
- `ok`: `0.15 < spread_pct <= 0.35`
- `bad`: `spread_pct > 0.35` or `ask < bid`

Thresholds should be configurable later; v1 can hardcode in one place.

## Implementation plan
### Step 1 — Centralize helpers (analysis layer)
**Files:**
- `options_helper/analysis/chain_metrics.py`

**Work:**
- Add helpers:
  - `compute_spread(df) -> Series[float|nan]`
  - `compute_spread_pct(df) -> Series[float|nan]`
  - `execution_quality(spread_pct: float|None) -> str`
- Keep pure and vectorized.

### Step 2 — Apply to roll-plan
**Files:**
- `options_helper/analysis/roll_plan.py`
- `options_helper/reporting_roll.py`

**Work:**
- Replace the local `_spread_ok` implementation with the centralized helpers.
- Ensure the printed candidate table includes `spread_pct` and `execution_quality`.

### Step 3 — Apply to research selection
**Files:**
- `options_helper/analysis/research.py`
- `docs/RESEARCH.md`

**Work:**
- When scoring/filtering candidates, compute spread_pct and:
  - exclude `execution_quality == bad` (default behavior), OR
  - apply a penalty weight (configurable later)
- Include `spread_pct` in the per-contract “why” list.

### Step 4 — Apply to analyze/advice
**Files:**
- `options_helper/analysis/advice.py`
- `options_helper/cli.py` (where `PositionMetrics` are assembled)

**Work:**
- Extend `PositionMetrics` with `spread`, `spread_pct`, `execution_quality`.
- In `advise()` add warnings:
  - wide spread → lower confidence / warn “fills may be poor”
  - missing bid/ask → warn “quote quality low”

### Step 5 — Surface in briefing/report-pack
**Files:**
- `options_helper/reporting_briefing.py`
- `docs/BRIEFING.md`

**Work:**
- Where contract-level rows are displayed (e.g., roll candidates / flow highlights), include `spread_pct` when available.

## Tests
- Unit tests for spread helpers:
  - bid/ask present
  - missing/zero
  - ask<bid
- Update existing CLI tests for:
  - roll-plan table includes spread columns
  - research output includes spread gating
  - advice emits warning when spread is wide

## Acceptance criteria
- `roll-plan` and `research` outputs visibly include spread info.
- `analyze` emits a warning for missing/wide spreads.
- No tests use the network; all new tests are deterministic.
