# IMP-042 — Candle cache → DuckDB

- **Status:** draft
- **Effort:** M
- **Alpha potential:** High

## Summary
Store daily OHLCV candles in DuckDB instead of per-symbol CSVs when `--storage duckdb` is enabled.

## Goals
- Implement `DuckDBCandleStore` that matches `CandleStore` behavior:
  - `load(symbol)` returns cached history
  - `save(symbol, history)` persists rows + meta
  - respects `auto_adjust`, `back_adjust`, and `interval` settings
- Update `load_ohlc_from_cache()` and CLI call sites to use the store factory.

## Non-goals
- Intraday candles (out of scope).
- Options snapshots (IMP-043).

## User-facing changes
- None (same CLI surface, same behavior) besides faster caching and fewer files.

## Design
### Tables
- `candles_daily(symbol, interval, auto_adjust, back_adjust, ts, open, high, low, close, volume, dividends, splits, capital_gains)`
- `candles_meta(symbol, interval, auto_adjust, back_adjust, updated_at, rows, start_ts, end_ts)`

### Settings-aware caching
- Cache is partitioned by `(symbol, interval, auto_adjust, back_adjust)` so adjusted/unadjusted series never mix.

## Implementation plan
### Step 1 — Implement DuckDBCandleStore
**Files:**
- `options_helper/data/stores_duckdb.py`

**Work:**
- Add `DuckDBCandleStore` which subclasses/patches `CandleStore` methods in DuckDB mode.

### Step 2 — Route candle store via factory
**Files:**
- `options_helper/data/store_factory.py`
- `options_helper/data/technical_backtesting_io.py`

**Work:**
- Use `get_candle_store()` in `load_ohlc_from_cache`.

### Step 3 — Update CLI call sites
**Files:**
- `options_helper/cli.py`

**Work:**
- Replace direct `CandleStore(...)` instantiation with factory calls.

## Tests
- `test_duckdb_candle_store.py`: save/load roundtrip and meta presence.

## Acceptance criteria
- Offline workflows that depend on candle cache continue to work.
- `--storage duckdb` produces no per-symbol candle CSVs.
