# IMP-012 — Earnings-aware event risk warnings + DTE gating

- **Status:** done
- **Effort:** S
- **Alpha potential:** High

## Summary
Integrate the existing earnings cache into daily workflows so the tool can warn when a position, roll candidate, or research idea **crosses an earnings event**.
This is not about predicting earnings moves — it’s about preventing unintentional event exposure.

## Goals
- Surface `next_earnings_date` in daily artifacts (briefing + analyze).
- Add warnings when:
  - a held position’s expiry is after the next earnings date (event risk),
  - a roll candidate crosses earnings,
  - a research recommendation would cross earnings.
- Optional gating to exclude candidates that cross earnings within a configurable window.

## Non-goals
- Estimating earnings move size.
- Maintaining a complete corporate events calendar (dividends/splits are a separate problem).

## User-facing changes
- New warning strings (consistent across commands):
  - `earnings_unknown`
  - `earnings_within_<N>d`
  - `expiry_crosses_earnings`
- New risk_profile fields in `portfolio.json` (all optional):
  - `earnings_avoid_days` (int, default: 0; when >0, exclude candidates with earnings within N days)
  - `earnings_warn_days` (int, default: 21; warn if earnings within N days)

## Design
### Event risk logic (simple + explainable)
Given:
- `today` = snapshot/candle as-of date (not wall-clock)
- `E` = next earnings date (may be unknown)
- `expiry` = option expiry date

Rules:
1. If `E` is unknown → emit `earnings_unknown` (warning only).
2. If `0 <= (E - today).days <= earnings_warn_days` → emit `earnings_within_<N>d`.
3. If `expiry >= E` and `E >= today` → emit `expiry_crosses_earnings`.
4. If `earnings_avoid_days > 0` and `(E - today).days <= earnings_avoid_days` → filter out candidates (research/roll).

## Implementation plan
### Step 1 — Add a small helper
**Files:**
- `options_helper/analysis/` (new file `events.py` OR add to `options_helper/data/earnings.py`)

**Work:**
- Implement `earnings_event_risk(today, expiry, next_earnings_date, *, warn_days, avoid_days) -> dict` returning:
  - `warnings: list[str]`
  - `exclude: bool`

Keep pure (no I/O).

### Step 2 — Thread earnings into commands
**Files:**
- `options_helper/cli.py`
- `options_helper/data/earnings.py`

**Work:**
- In CLI commands that already know symbols (analyze, research, roll-plan, briefing):
  - load `EarningsStore(Path("data/earnings"))` once
  - lookup `next_earnings_date` per symbol
  - pass it into analysis layer as a value

### Step 3 — Apply to research + roll-plan
**Files:**
- `options_helper/analysis/research.py`
- `options_helper/analysis/roll_plan.py`

**Work:**
- Add warnings to candidate output.
- Apply `exclude` gating when configured.

### Step 4 — Surface in analyze + briefing
**Files:**
- `options_helper/analysis/advice.py`
- `options_helper/reporting_briefing.py`
- `docs/BRIEFING.md`

**Work:**
- Add a one-liner per symbol/position:
  - `Next earnings: YYYY-MM-DD (in X days)` or `unknown`.
- Add warnings when event risk triggers.

## Tests
- Add a pure unit test for `earnings_event_risk`.
- Add CLI tests that:
  - stub earnings store for a symbol
  - confirm warnings appear
  - confirm filtering excludes candidates when `earnings_avoid_days` is set

## Acceptance criteria
- Running `refresh-earnings` + the daily pipeline results in briefing/analyze that include earnings context.
- No command crashes when earnings are missing/unknown.
