# IMP-031 — Repo cleanup (cont.): finish modular CLI + stabilize test seams (no behavior changes)

- **Status:** draft
- **Effort:** M–L
- **Alpha potential:** Medium

## Summary
Continue the refactor started in [IMP-030](./IMP-030.md) by moving the remaining CLI command groups out of
`options_helper/cli.py` into `options_helper/commands/*`, while keeping the CLI surface and artifact schemas stable.
At the same time, harden the test/DI seams so future refactors don’t require brittle monkeypatch updates.
This plan is for information/decision support only and is not financial advice.

## Goals
- Keep CLI surface stable:
  - command names/flags unchanged
  - output paths and artifact schemas unchanged
- Make `options_helper/cli.py` primarily “wiring” (app setup + shared options + command registration).
- Standardize dependency construction and test stubbing around `options_helper/cli_deps.py` (stable seam).
- Keep tests offline and deterministic; add regression coverage where missing.
- Keep `options-helper --help` fast (avoid heavy imports at import time).

## Non-goals
- New features or behavior changes.
- Renaming commands/flags, changing output layouts, or changing artifact schemas.
- Adding heavy dependencies.

## User-facing changes
- None intended (help text ordering may change slightly).

## Design
### Inputs
- Existing CLI args and environment variables.
- Local state under `data/` (gitignored).
- Test fixtures under `tests/fixtures/`.

### Outputs / schemas
- Existing JSON artifacts remain schema-valid and unchanged.
- Any new fixtures live under `tests/fixtures/` only.

### Key refactor rules (to keep tests stable)
- Prefer `import options_helper.cli_deps as cli_deps` in command modules and in `options_helper/cli.py`.
  - Avoid `from options_helper.cli_deps import build_*` in command modules so monkeypatching
    `options_helper.cli_deps.*` always works.
- Command modules should either:
  - export a Typer sub-app (`app = typer.Typer(...)`) for named command groups, or
  - export `register(app: typer.Typer) -> None` for root-level commands (to preserve names).

## Implementation plan
### Step 1 — Utilities + plumbing: stabilize the DI seam
**Files:**
- `options_helper/cli.py`
- `options_helper/commands/*` (as needed)
- tests that monkeypatch provider/store builders

**Work:**
- Switch command modules and `options_helper/cli.py` to `import options_helper.cli_deps as cli_deps`.
- Update call sites to use `cli_deps.build_*`.
- Update tests to monkeypatch `options_helper.cli_deps.*` (preferred seam) instead of `options_helper.cli.*`.

### Step 2 — Extract `derived` CLI group into `options_helper/commands/derived.py`
**Files:**
- `options_helper/commands/derived.py` (new)
- `options_helper/cli.py`
- `tests/test_derived_cli.py` (as needed)

**Work:**
- Move the `derived` Typer app and commands out of `options_helper/cli.py`.
- Keep command names/flags/help text stable.

### Step 3 — Extract `scanner` CLI group into `options_helper/commands/scanner.py`
**Files:**
- `options_helper/commands/scanner.py` (new)
- `options_helper/cli.py`
- `tests/test_scanner_cli.py` (as needed)

**Work:**
- Move the `scanner` Typer app and commands out of `options_helper/cli.py`.
- Keep outputs unchanged (CSV/JSON/MD paths under `data/reports/...`).

### Step 4 — Extract `journal` CLI group into `options_helper/commands/journal.py`
**Files:**
- `options_helper/commands/journal.py` (new)
- `options_helper/cli.py`
- `tests/test_journal_cli.py` (as needed)

**Work:**
- Move the `journal` Typer app and commands out of `options_helper/cli.py`.
- Keep offline behavior stable (no provider instantiation when `--offline` is set).

### Step 5 — Split remaining root commands into modules (incremental)
**Files:**
- `options_helper/commands/portfolio.py` (new; root portfolio CRUD)
- `options_helper/commands/reports.py` (new; flow/chain-report/compare/report-pack/briefing/dashboard/roll-plan)
- `options_helper/commands/workflows.py` (new; analyze/research/daily/snapshot-options/earnings/refresh-*)
- `options_helper/cli.py`

**Work:**
- Use `register(app)` to preserve root-level command names.
- Move one cluster at a time and keep tests green after each move.
- Keep heavy imports behind command functions when practical.

### Step 6 — Add/extend regression tests where coverage is thin
**Files:**
- `tests/test_cli_contract.py` (extend only if needed)
- optional new tests (keep small and resilient)

**Work:**
- Add one additional “artifact schema regression” test for a core workflow not already covered in end-to-end CLI tests.
- Extend the `--help` import guard if new accidental heavy imports show up during the refactor.

### Step 7 — Close-out
**Files:**
- `docs/plans/IMP-031.md`
- `docs/plans/README.md`
- `docs/REPO_IMPROVEMENTS.md` (only if ranks/status change)

**Work:**
- Run full test suite (`python -m pytest`).
- Update plan status to **done** with date and add a short “Shipped implementation” section (like IMP-030/IMP-029).

## Tests
- Keep tests offline and deterministic (no network calls).
- Run focused tests after each step (examples):
  - Step 1: `pytest -k "cli_contract or analyze_offline or snapshot_options_full or earnings_cli"`
  - Step 2: `pytest -k "derived_cli or cli_contract"`
  - Step 3: `pytest -k "scanner_cli or cli_contract"`
  - Step 4: `pytest -k "journal_cli or cli_contract"`
  - Step 5: run the specific CLI tests for the moved command cluster(s)
- Final: `pytest`

## Acceptance criteria
- `python -m pytest` passes.
- `options-helper --help` and key subcommand helps still contain the expected commands/flags.
- Existing artifacts remain schema-valid and path-stable.
- `options_helper/cli.py` is primarily wiring and materially smaller than before the refactor.
