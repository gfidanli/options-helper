# IMP-040 — DuckDB scaffold + migrations + CLI toggles

- **Status:** draft
- **Effort:** S–M
- **Alpha potential:** Very High

## Summary
Introduce the foundational DuckDB “warehouse” layer with migrations and a small CLI surface.
This is the base for later IMPs that move individual stores (candles, snapshots, derived, journal) onto DuckDB.

## Goals
- Add a new embedded DB module: `options_helper.db` (DuckDB connect + migrations).
- Add a runtime toggle to select storage backend: `filesystem` (default) vs `duckdb`.
- Add CLI entry points to initialize and inspect the DB (`options-helper db init|info`).

## Non-goals
- Migrating all existing stores in this IMP (handled by IMP-041..043).
- Multi-user/web deployment concerns.

## User-facing changes
- New CLI flags (global):
  - `--storage {filesystem|duckdb}` (default: filesystem)
  - `--duckdb-path PATH` (default: `data/warehouse/options.duckdb`)
- New CLI group:
  - `options-helper db init`
  - `options-helper db info`

## Design
### Warehouse vs lake
- This IMP only creates the **warehouse** (DuckDB file) and migrations table.
- Lake writes (Parquet) come later in IMP-043.

### Runtime configuration
- Use `contextvars` (mirrors provider runtime) so CLI can set storage config once at startup.

## Implementation plan
### Step 1 — Add DuckDB dependency
**Files:**
- `pyproject.toml`

**Work:**
- Add `duckdb` to `[project].dependencies`.

### Step 2 — Add DuckDB warehouse + migrations module
**Files:**
- `options_helper/db/__init__.py`
- `options_helper/db/warehouse.py`
- `options_helper/db/migrations.py`
- `options_helper/db/schema_v1.sql`

**Work:**
- Implement `DuckDBWarehouse` (connect/execute/transaction).
- Implement schema migrations:
  - `schema_migrations` bookkeeping table
  - `ensure_schema()` applies v1 schema idempotently.

### Step 3 — Add storage runtime + store factory
**Files:**
- `options_helper/data/storage_runtime.py`
- `options_helper/data/store_factory.py`

**Work:**
- Implement `get_default_storage_backend`, `set_default_storage_backend`, etc.
- Provide factory functions (initially filesystem-only, but ready to route to DuckDB stores).

### Step 4 — Wire CLI flags + DB commands
**Files:**
- `options_helper/cli.py`

**Work:**
- Add `--storage` and `--duckdb-path` to the root callback.
- Add a new `db` Typer sub-app with `init` and `info`.
- Ensure resources are closed on CLI shutdown.

## Tests
- Add a small unit test that `ensure_schema()` creates the `schema_migrations` table and sets schema version to 1.

## Acceptance criteria
- `options-helper db init` creates the DB file and prints a short success message.
- `options-helper db info` prints current schema version and file path.
- Running the CLI without specifying `--storage` behaves exactly as before.
