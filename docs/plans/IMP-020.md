# IMP-020 — Canonical option contract IDs (OSI) + normalization layer

- **Status:** done
- **Effort:** M
- **Alpha potential:** High

## Summary
Today snapshots and joins key off `contractSymbol` (Yahoo's string). For robust history, provider swaps, and multi-leg strategies, we need a canonical identifier. Implement an OSI (Options Symbology Initiative) parser/formatter and use it as the primary contract key in snapshots, derived tables, journaling, and backtesting.

## Goals
- Parse `contractSymbol` into a canonical structured form: underlying, expiry, type, strike.
- Format a canonical OSI string (stable) and store it as `osi` alongside `contractSymbol`.
- Normalize underlying tickers consistently (e.g., BRK.B vs BRK-B) with a single mapping function.
- Prefer `osi` as the primary key for:
  - snapshot de-dupe
  - compare/flow joins
  - roll-plan and backtest lookup

## Non-goals
- Supporting every OCC edge-case on day 1 (e.g., adjusted options, non-standard deliverables). v1 can warn and fall back.

## User-facing changes
- Snapshot CSVs gain:
  - `osi` column
  - `underlying_norm` (optional)
- Reports may show OSI as the stable identifier when helpful.

## Design
### Parsing
- Yahoo `contractSymbol` is often OSI-like, but not always perfectly spec-compliant.
- Implement a tolerant parser:
  - if parse succeeds, emit structured fields
  - if parse fails, emit warnings and keep using raw `contractSymbol`

### Strike representation
Store strike in dollars as a float in the analysis layer.
In the OSI string, store strike as 8 digits representing strike * 1000 (standard OSI encoding).

## Implementation plan
### Step 1 — Add parser/formatter utilities
**Files:**
- `options_helper/analysis/osi.py` (new)

**Work:**
- `parse_contract_symbol(raw: str) -> ParsedContract | None`
- `format_osi(parsed: ParsedContract) -> str`
- `normalize_underlying(symbol: str) -> str`

### Step 2 — Add OSI to snapshots
**Files:**
- `options_helper/data/options_snapshotter.py`
- `options_helper/data/options_snapshots.py`

**Work:**
- When writing snapshot CSVs, add `osi` for each row.
- In `load_day`, de-dupe by `osi` when available, else by `contractSymbol`.

### Step 3 — Adopt OSI in analysis joins
**Files:**
- `options_helper/analysis/flow.py`
- `options_helper/analysis/compare_metrics.py`
- `options_helper/analysis/roll_plan.py`

**Work:**
- Join/diff primarily on `osi` when present.

### Step 4 — Tests
**Files:**
- `tests/test_osi.py` (new)

**Work:**
- Parse known OSI strings.
- Round-trip format(parse(x)) == canonical(x).
- Ensure snapshot de-dupe behaves correctly.

## Acceptance criteria
- New snapshots include `osi`.
- Joining two snapshot days works even when `contractSymbol` formatting differs.
