# IMP-023 — Options contract universe + expiry listing + contract cache (Alpaca)

- **Status:** done
- **Effort:** M
- **Alpha potential:** High

## Summary
Implement Alpaca-backed option contract discovery so we can:
- list expiries reliably (`list_option_expiries`)
- cache contract metadata (strike/type/expiry, plus open interest + OI date)
- reuse this metadata to enrich option chain snapshots (IMP-024/026) and avoid repeated API calls.

Alpaca’s option-chain snapshot endpoint is great for quotes/greeks, but **open interest** and contract metadata are exposed via
the **options contracts** endpoints (Trading API). This IMP establishes the contract “source of truth” layer.

## Goals
- Implement `MarketDataProvider.list_option_expiries(symbol)` using Alpaca option contracts.
- Create a disk-backed `OptionContractsStore` cache to avoid re-fetching thousands of contracts repeatedly.
- Normalize contract metadata into a DataFrame schema that can be joined into chain snapshots.

## Non-goals
- Fetch option chain quotes/greeks (IMP-024).
- Fetch option bars/trades/quotes for volume (IMP-025).
- Full multi-underlying contract scanning (start with one underlying symbol at a time).

## User-facing changes
- Faster and more reliable expiry listing on Alpaca.
- New cache directory (default under `data/` if used by CLI workflows):
  - `data/option_contracts/<SYMBOL>/<YYYY-MM-DD>/contracts.csv`
  - `data/option_contracts/<SYMBOL>/<YYYY-MM-DD>/contracts.raw.json` (optional)

## Design
### Normalized contract schema
Minimum columns (keep additive and simple):
- `contractSymbol` (Alpaca’s contract symbol; OSI-like)
- `underlying` (repo-canonical underlying)
- `expiry` (YYYY-MM-DD string)
- `optionType` (`call`/`put`)
- `strike` (float, dollars)
- `multiplier` (int, usually 100)
- `openInterest` (int or NA)
- `openInterestDate` (YYYY-MM-DD or NA)
- `closePrice` (float or NA)
- `closePriceDate` (YYYY-MM-DD or NA)

### Cache keying
- Key contracts cache by:
  - `provider_name`, `provider_version`
  - `underlying`
  - `fetched_at` (UTC)
  - request filters (e.g., expiry window)
- Prefer per-day snapshots (aligned with existing snapshot store patterns).

### Pagination
Alpaca contract listing endpoints paginate. The client wrapper must:
- follow `page_token` until exhausted
- enforce a hard cap to prevent runaway loops (configurable max pages)

## Implementation plan
### Step 1 — Add contracts store
**Files:**
- `options_helper/data/option_contracts.py` (new)

**Work:**
- Implement `OptionContractsStore(root_dir: Path)`:
  - `save(symbol, as_of: date, df: pd.DataFrame, *, raw: dict | None, meta: dict)`
  - `load(symbol, as_of: date) -> pd.DataFrame | None`
  - `load_meta(symbol, as_of: date) -> dict`
- Use CSV for the normalized table and JSON for meta/raw (same style as candles/snapshots).

### Step 2 — Add Alpaca contract fetcher
**Files:**
- `options_helper/data/alpaca_client.py`

**Work:**
- Add `list_option_contracts(underlying: str, *, exp_gte, exp_lte, limit, page_limit) -> list[dict]`
  - Use Alpaca Trading API client.
- Add `contracts_to_df(raw_contracts) -> pd.DataFrame`
  - Normalize into schema above.
  - Ensure `contractSymbol` matches the rest of the repo (stored under that column name).

### Step 3 — Implement provider expiry listing (with cache)
**Files:**
- `options_helper/data/providers/alpaca.py`

**Work:**
- Implement `list_option_expiries(symbol)`:
  - fetch contracts (or load from cache)
  - compute unique expiries (as `datetime.date`)
  - sort ascending
- Add fast path: if cache exists for today, reuse.

## Tests
- `tests/providers/test_alpaca_contracts_cache.py` (new)
  - store save/load round-trip
  - meta schema contains provider name/version and row counts
- `tests/providers/test_alpaca_list_expiries.py` (new)
  - mocked contracts list returns correct unique sorted expiries

## Acceptance criteria
- `provider.list_option_expiries("SPY")` returns a non-empty sorted list (when API allows).
- Repeated expiry listings on the same day hit the cache (no repeated pagination calls).
- Contract DataFrame schema is stable and joinable with chain snapshots by `contractSymbol`.
