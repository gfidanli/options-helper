# IMP-005 — `analyze` offline-first mode

- **Status:** done
- **Effort:** M
- **Alpha potential:** Medium

## Summary
Add an offline-first mode to `options-helper analyze` so it can run deterministically from `data/options_snapshots/` and the candle cache. This enables repeatable evaluation and reduces dependence on live Yahoo quotes.

## Shipped
- CLI: `options-helper analyze portfolio.json --offline --as-of latest`
- Flags: `--offline-strict`, `--snapshots-dir` (snapshots root), and `--cache-dir` (candle cache)
- Offline behavior:
  - No live `yfinance` calls (uses snapshot CSVs + candle cache only)
  - Option rows are matched by `(expiry, strike, type)` (portfolio doesn’t persist `contractSymbol` yet)
  - Missing snapshot coverage warns by default; `--offline-strict` exits non-zero

## Goals
- Add `--offline` and `--as-of` (snapshot date spec) flags to `analyze`.
- When offline:
  - underlying price comes from candle cache close as-of the chosen date
  - option mark/bid/ask/IV/OI/volume comes from the corresponding snapshot row (by `contractSymbol`)
  - emit clear warnings when snapshot data is missing
- Keep online behavior as the default and fallback mechanism.

## Non-goals
- Intraday updates (this remains a daily workflow).
- Perfect fills (that’s IMP-001/IMP-013 territory).

## User-facing changes
- New flags:
  - `options-helper analyze portfolio.json --offline --as-of latest`
  - `--offline-strict` (optional): fail if any position is missing a snapshot

## Design
### Snapshot resolution
- Use `OptionsSnapshotStore.resolve_date(symbol, spec)` to pick the day.
- Load the day and locate the position’s row:
  - primary key: `contractSymbol` (later replaced by OSI ID via IMP-020)
  - fallback match: (expiry, strike, type) if contractSymbol is missing

### Time alignment
- Use the snapshot date (folder) as the authoritative “as-of”.
- Underlying close comes from the candle cache at or before that date.

## Implementation plan
### Step 1 — Add CLI flags and wiring
**Files:**
- `options_helper/cli.py`

**Work:**
- Extend the `analyze` command signature to accept `--offline/--online` and `--as-of`.
- Instantiate `OptionsSnapshotStore(Path("data/options_snapshots"))` when offline.

### Step 2 — Teach `_position_metrics` to use snapshot rows
**Files:**
- `options_helper/cli.py`

**Work:**
- Update `_position_metrics(...)` to accept an optional `snapshot_row: dict|Series|None`.
- When provided, fill `mark/bid/ask/last/iv/oi/vol` from snapshot values.
- Compute `spread_pct` and quality warnings via IMP-001/IMP-013 helpers.

### Step 3 — Update docs
**Files:**
- `docs/BRIEFING.md` (mention determinism)
- `README.md` (add an example offline analyze invocation)

### Step 4 — Add tests
**Files:**
- `tests/test_advice.py` and/or new `tests/test_analyze_offline.py`

**Work:**
- Create fixture snapshots for a symbol/contract.
- Verify `analyze --offline` runs without network and produces expected warnings/metrics.

## Acceptance criteria
- `analyze --offline --as-of latest` runs with no `yfinance` calls.
- If a position lacks snapshot coverage, the tool:
  - warns by default, and
  - fails only under `--offline-strict`.
