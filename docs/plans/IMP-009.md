# IMP-009 — Data-provider abstraction (swap Yahoo for better data)

- **Status:** done
- **Effort:** L
- **Alpha potential:** Very High

## Summary
Yahoo/yfinance is the current limiting reagent: stale quotes, missing fields, and inconsistent OI/IV.
Introduce a provider abstraction layer so the rest of the system (candles, snapshots, earnings, quotes) can swap in higher-quality sources without rewriting analysis code.

## Goals
- Create a clear interface (protocol/ABC) for market data operations:
  - fetch candles
  - fetch spot/quote
  - fetch option chain (per expiry)
  - fetch earnings date (optional)
- Make Yahoo provider one implementation behind that interface.
- Ensure analysis modules remain provider-agnostic (operate on normalized DataFrames).

## Non-goals (v1)
- Implementing multiple paid providers immediately.
- Handling every exotic asset type (start with US equities and their listed options).

## User-facing changes
- New CLI/global config:
  - `--provider yahoo` (default)
  - `--provider <name>`
- `meta.json` for snapshots includes `provider` and `provider_version` when available.

## Design
### Provider interface
Create `MarketDataProvider` with methods like:
- `get_history(symbol, *, start, end, interval) -> DataFrame`
- `get_quote(symbol) -> Quote`
- `list_option_expiries(symbol) -> list[date]`
- `get_option_chain(symbol, expiry) -> DataFrame`
- `get_next_earnings(symbol, *, today) -> EarningsEvent`

### Normalization contract
Define and document a normalized option-chain schema (column names + units):
- required: `contractSymbol`, `expiry`, `strike`, `optionType`, `bid`, `ask`, `lastPrice`, `openInterest`, `volume`, `impliedVolatility`
- optional: `lastTradeDate`, greeks fields, etc.

All providers must output this schema (missing fields are allowed as nulls).

## Implementation plan
### Phase 1 — Introduce interface + Yahoo adapter
**Files:**
- `options_helper/data/providers/base.py` (new)
- `options_helper/data/providers/yahoo.py` (new; wraps existing `yf_client.py`)
- refactor `options_helper/data/yf_client.py` into the Yahoo provider or keep as an internal helper

**Work:**
- Move yfinance calls behind the provider.
- Update CLI to instantiate provider based on config.

### Phase 2 — Convert callers
**Files:**
- `options_helper/data/candles.py`
- `options_helper/data/options_snapshotter.py`
- `options_helper/data/universe.py`
- `options_helper/cli.py`

**Work:**
- Replace direct `YFinanceClient()` usage with `get_provider()`.
- Ensure tests monkeypatch provider methods rather than yfinance internals.

### Phase 3 — Add a “mock provider” for tests
**Files:**
- `options_helper/data/providers/mock.py` (new)

**Work:**
- Provide deterministic in-memory responses for unit tests and demos.

## Tests
- Unit tests for normalization (provider output columns).
- CLI tests that run using the mock provider.
- Regression test: existing workflows still work with the Yahoo provider.

## Acceptance criteria
- No analysis module imports `yfinance` directly.
- Switching providers does not require changing analysis code.
