# IMP-030 — Repo cleanup: modular CLI + regression tests (no behavior changes)

- **Status:** done (2026-02-04; continued in IMP-031)
- **Effort:** M–L
- **Alpha potential:** Medium

## Summary
Pay down technical debt safely by adding regression tests first, then refactoring the CLI into smaller modules while
preserving existing command names/flags/outputs. The goal is to make the repo faster to change without breaking the
working daily workflows (and to keep tests deterministic/offline).
This plan is for information/decision support only and is not financial advice.

## Scope (as shipped)
- Added a stable dependency-construction seam: `options_helper/cli_deps.py`.
- Added CLI contract regression tests and one artifact regression test.
- Moved several large command groups out of `options_helper/cli.py` into `options_helper/commands/*` to reduce
  import-time and refactor risk.

Remaining CLI modularization + test seam hardening continues in [IMP-031](./IMP-031.md).

## Goals
- Keep the CLI surface stable:
  - `options-helper ...` command names and flags do not change.
  - output paths and JSON artifact schemas remain unchanged.
- Reduce `options_helper/cli.py` size and import complexity.
- Add regression tests that protect “what’s working today” (especially offline paths).
- Create stable, test-friendly dependency injection points (provider/caches/stores) to reduce fragile monkeypatching.

## Non-goals
- New features or “behavior improvements” (this IMP is refactor + test hardening only).
- Changing artifact schemas, file layouts, or cron semantics.
- Introducing heavy new dependencies.

## User-facing changes
- None intended (help text ordering may change slightly, but command names/flags/outputs should not).

## Design
### Inputs
- Existing CLI args and environment variables.
- Existing local state under `data/` (gitignored).
- Existing fixtures under `tests/fixtures/` for deterministic tests.

### Outputs / schemas
- Existing JSON artifacts remain schema-valid and unchanged (validated via `options_helper/schemas/*`).
- Any new “regression fixtures” are committed under `tests/fixtures/` only (never `data/`).

### Key refactor approach (safe)
- Keep `options_helper/cli.py` as the only public entrypoint that defines/exports `app`.
- Introduce a small internal dependency builder module (example name: `options_helper/cli_deps.py`) with functions like:
  - `build_provider(name: str) -> MarketDataProvider`
  - `build_candle_store(cache_dir: Path, provider: MarketDataProvider) -> CandleStore`
  - `build_snapshot_store(snapshots_dir: Path) -> OptionsSnapshotStore`
- Move command implementations into a new internal package that does **not** conflict with `options_helper/cli.py`,
  e.g. `options_helper/commands/` (or `options_helper/cli_commands/`).
- Migrate commands iteratively (one Typer sub-app or command group at a time) and keep tests green at each step.

## Implementation plan
### Step 1 — Add CLI contract regression tests (first)
**Files:**
- `tests/test_cli_contract.py` (new)

**Work:**
- Assert `from options_helper.cli import app` works.
- Assert `options-helper --help` includes expected top-level commands/subcommands.
- Assert key commands still expose required flags (`--offline`, `--as-of`, `--snapshots-dir`, etc.).
- Keep assertions resilient (presence checks, not brittle full-output snapshots).

### Step 2 — Add deterministic “offline golden” tests for core workflows
**Files:**
- `tests/test_analyze_offline_regression.py` (new, or extend existing tests)
- `tests/test_briefing_offline_regression.py` (new, optional)
- `tests/fixtures/` (extend only as needed)

**Work:**
- Run a small set of commands end-to-end in offline mode against fixtures:
  - `analyze --offline --as-of <date>` (uses candle cache + snapshots)
  - at least one artifact-producing command (e.g., `briefing`, `flow`, `chain-report`, `scanner`) in offline mode
- Validate produced JSON via the existing schema models.
- Avoid network; prefer stubbing at a single boundary (provider + candle history fetch).

### Step 3 — Introduce stable dependency builders and update CLI/tests to use them
**Files:**
- `options_helper/cli_deps.py` (new)
- `options_helper/cli.py`
- tests that currently monkeypatch `options_helper.cli.*` builder call sites

**Work:**
- Centralize construction of providers/stores in `cli_deps`.
- Update `options_helper/cli.py` to call `cli_deps.*` instead of instantiating directly.
- Update tests to monkeypatch `options_helper.cli_deps.*` (stable API), reducing sensitivity to internal refactors.

### Step 4 — Split `options_helper/cli.py` into smaller internal command modules (incremental)
**Files:**
- `options_helper/commands/__init__.py` (new)
- `options_helper/commands/<area>.py` (new per area)
- `options_helper/cli.py`

**Work:**
- Move one Typer group at a time (e.g., `journal`, then `scanner`, then `backtest`, etc.).
- Keep `options_helper/cli.py` as wiring only: build sub-apps, register commands, shared helpers, global callback.
- Ensure import paths used by tests and the `options-helper` entrypoint remain valid.

### Step 5 — Reduce import-time cost (keep `--help` fast)
**Files:**
- `options_helper/cli.py`
- `options_helper/commands/*`

**Work:**
- Move heavyweight imports behind function boundaries where safe (avoid loading pandas/backtesting stacks for `--help`).
- Add/extend a test that `--help` executes quickly enough to prevent accidental import bombs (time-bounded, but not flaky).

### Step 6 — (Optional) Expand type checking scope safely
**Files:**
- `pyproject.toml`
- selected modules with low churn first (new `options_helper/commands/*`, plus `options_helper/data/*` seams)

**Work:**
- Expand mypy to additional files in “informational” mode first (don’t block CI initially).
- Keep focus on interfaces and boundary types (providers/stores/artifact payloads).

## Tests
- All existing tests must stay green throughout.
- New tests added in Step 1–2 serve as regression coverage for the refactor.
- Prefer offline, deterministic tests (no current time, no network, no dependency on local `data/`).

## Acceptance criteria
- `./.venv/bin/python -m pytest` passes (and CI stays green).
- `options-helper --help` and key subcommand `--help` outputs still include the expected commands/flags.
- No changes required to cron scripts or docs to keep existing workflows running.

## Shipped implementation (2026-02-04)
### New modules / seams
- Dependency builders: `options_helper/cli_deps.py`
- Command modules (initial split): `options_helper/commands/watchlists.py`, `options_helper/commands/technicals.py`,
  `options_helper/commands/backtest.py`, `options_helper/commands/technicals_common.py`

### Regression tests added
- CLI contract: `tests/test_cli_contract.py`
- Artifact regression: `tests/test_flow_artifact_cli.py`

## Follow-ups
- Continue the remaining CLI split + test seam stabilization in [IMP-031](./IMP-031.md).
