# IMP-002 — IV vs Realized Vol + IV percentile + term structure in the daily loop

- **Status:** done
- **Effort:** M
- **Alpha potential:** High

## Summary
Add a volatility regime panel that the rest of the tool can consume: realized volatility from candles, implied volatility from snapshots, IV/RV ratio, IV percentile, and simple term-structure slope.

The goal is **context**, not prediction: help you interpret whether premium is cheap/expensive and whether the chain is pricing unusual move risk.

## Goals
- Compute and persist realized vol time-series per symbol (from cached candles).
- Extend derived metrics to include:
  - `rv_20d` (annualized)
  - `rv_60d` (annualized)
  - `iv_rv_20d` = `atm_iv_near / rv_20d`
  - `atm_iv_near_percentile` (vs derived history)
  - `iv_term_slope` (near vs next expiry ATM IV)
- Surface in:
  - `derived` stats output
  - `briefing` takeaways
  - `research` (as a ranking context field)

## Non-goals
- Building a full IV surface model.
- Claiming any trading edge from IV/RV alone.

## User-facing changes
- Briefing: add a “Vol regime” line per symbol.
- Derived: new columns and percentile stats.
- Research: show IV/RV + IV percentile alongside each recommendation.

## Design
### Realized volatility
- Use log returns on **adjusted close** (the candle cache already supports auto_adjust).
- Rolling stdev of daily log returns, annualized by `sqrt(252)`.
- Provide two windows by default: 20D and 60D.

### Term-structure slope (simple)
- Compute ATM IV for:
  - near expiry (already `atm_iv_near`)
  - next selected expiry (`atm_iv_next`)
- `iv_term_slope = atm_iv_next - atm_iv_near` (in absolute IV, not % points)

If next expiry is missing, slope is `None`.

## Implementation plan
### Step 1 — Add RV helpers (pure)
**Files:**
- `options_helper/analysis/indicators.py` (or a new `volatility.py`)

**Work:**
- Implement `realized_vol(close: Series, window: int) -> Series` returning annualized RV.
- Add tests for known synthetic series.

### Step 2 — Extend chain metrics to expose second-expiry ATM IV
**Files:**
- `options_helper/analysis/chain_metrics.py`

**Work:**
- In the `ChainReport` (or expiry stats), expose ATM IV for at least the first 2 expiries so derived can compute slope.

### Step 3 — Extend derived rows + store
**Files:**
- `options_helper/analysis/derived_metrics.py`
- `options_helper/data/derived.py`
- `docs/DERIVED.md`

**Work:**
- Add columns for RV and IV regime metrics.
- Populate RV fields from candle cache at the snapshot date.
- Populate IV fields from chain-report output.

### Step 4 — Surface in briefing + research
**Files:**
- `options_helper/reporting_briefing.py`
- `options_helper/analysis/research.py`
- `docs/BRIEFING.md`, `docs/RESEARCH.md`

**Work:**
- Add “Vol regime” section/line.
- Include IV/RV context in per-idea reasons (no filtering by default).

## Tests
- Unit tests for RV calculations.
- Golden tests for derived CSV columns (schema stability).
- Briefing JSON artifact includes the new fields.

## Acceptance criteria
- After running `snapshot-options` + `derived`, the derived file contains RV + IV regime columns.
- Briefing includes a concise volatility regime summary per symbol.
