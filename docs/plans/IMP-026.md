# IMP-026 — Snapshot enrichment: store more Alpaca fields for future features

- **Status:** draft
- **Effort:** S–M
- **Alpha potential:** High

## Summary
Once Alpaca is the provider, we should **persist as much relevant option-chain context as is reasonably cheap** at snapshot time
so future analytics can be built without resnapshotting.

This IMP extends the option snapshot rows (CSV) and raw payload meta to include:
- provider greeks and IV (when present)
- precise timestamps for quotes/trades
- open interest date + close price date from contracts metadata

All changes are additive and backward compatible.

## Goals
- Add optional columns to the snapshot DataFrame for Alpaca that are commonly useful:
  - `quoteTime`, `tradeTime` (RFC3339)
  - `delta`, `gamma`, `theta`, `vega`, `rho` (provider greeks)
  - `iv` (provider IV) OR keep using `impliedVolatility` but record provenance
  - `openInterestDate`, `closePriceDate`
- Add meta fields to `meta.json` to record:
  - Alpaca feed used (`opra` vs `indicative`)
  - any filters used (strike bands, etc.)

## Non-goals
- Changing any downstream analytics to *require* these fields.
- Introducing schema-breaking changes to existing snapshots.

## User-facing changes
- Snapshot CSVs get additional columns (nullable).
- `meta.json` includes Alpaca-specific provenance.

## Design
### Column naming
Keep existing normalized names and add provider fields as optional columns:
- Prefer normalized names where they match semantics:
  - `impliedVolatility` stays the column used by the repo.
- Add new columns only when they represent *new* information:
  - `openInterestDate`, `tradeTime`, `quoteTime`, etc.

### Provenance
Add a simple provenance column (optional):
- `iv_source`: `alpaca_snapshot` | `bs_inferred` | `missing`

This supports debugging and later quality scoring.

## Implementation plan
### Step 1 — Extend Alpaca chain row mapping
**Files:**
- `options_helper/data/alpaca_client.py`
- `options_helper/data/providers/alpaca.py`

**Work:**
- When flattening `OptionsSnapshot`:
  - map `latest_quote.timestamp` → `quoteTime`
  - map `latest_trade.timestamp` → `tradeTime`
  - map `greeks.*` into columns when present
- When joining contracts metadata:
  - include `openInterestDate`
  - include `closePriceDate`/`closePrice`

### Step 2 — Persist feed + filters in snapshot meta
**Files:**
- `options_helper/data/options_snapshotter.py` (minor)
- `options_helper/data/providers/alpaca.py`

**Work:**
- Ensure `meta.json` includes:
  - `provider_params: { "options_feed": "...", "stock_feed": "...", "recent_bars_buffer_minutes": ... }`

### Step 3 — Keep schema stable
**Files:**
- `options_helper/data/providers/base.py` (no changes to required columns)

**Work:**
- Do *not* add to `OPTION_CHAIN_REQUIRED_COLUMNS` unless a field is required by core analysis.

## Tests
- `tests/providers/test_alpaca_snapshot_enrichment.py` (new)
  - row mapping includes optional fields when present
  - absence of greeks does not crash; fields become NA
  - timestamps are RFC3339-ish strings parseable by pandas

## Acceptance criteria
- Snapshotter output includes the new columns without breaking existing tests/consumers.
- `meta.json` reliably records Alpaca feed/params for provenance.
