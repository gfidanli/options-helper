# IMP-025 — Options volume + “recent bars restriction” hardening (Alpaca)

- **Status:** draft
- **Effort:** M
- **Alpha potential:** High

## Summary
Improve Alpaca option-chain snapshots by adding **volume** (and optionally last trade count / VWAP) using the option bars endpoint.
Also centralize mitigation for Alpaca’s plan-based limitation where historical bars cannot be queried into the most recent ~15 minutes.

This materially improves:
- liquidity scoring
- spread realism
- IV inference in `add_black_scholes_greeks_to_chain` (it uses volume gating for last-based IV inference)

## Goals
- Populate `volume` for each option contract in snapshot rows (best-effort).
- Add optional columns that enable future features:
  - `vwap`, `trade_count` (if present in bar model)
- Standardize “end time buffer” behavior for *all* bar requests.

## Non-goals
- Trade-by-trade volume classification (IMP-027).
- Full intraday volume curves (IMP-027).
- Guarantee volume availability for every contract (sparse contracts may not have bars).

## User-facing changes
- Quote quality scores become more informative when running with `--provider alpaca`.
- Fewer confusing runtime errors on accounts/plans that restrict “most recent bar” queries.

## Design
### Efficient volume fetch
Fetching bars per contract naively will explode request counts. Instead:
- Use `OptionHistoricalDataClient.get_option_bars(OptionBarsRequest(...))` with **batched symbols**.
- Chunk contract symbols per request (e.g., 200–500) to balance payload size and rate limits.
- Use `timeframe=1Day` or `timeframe=1Hour` depending on desired granularity.
  - v1: use 1Day bars and take the latest bar’s volume for “today”.

### Date/time alignment
- Snapshotter’s `snapshot_date` is derived from the latest candle close.
- For volume bars:
  - request `start = snapshot_date 00:00:00 UTC` (or market timezone converted to UTC)
  - request `end = now - buffer_minutes` (configurable), or end-of-day for historical snapshots

### Recent bars restriction mitigation
Implement once in `AlpacaClient`:
- `effective_end(end: datetime | None) -> datetime | None`
- if end is None:
  - set end = utcnow() - buffer_minutes
- if end is set:
  - do not modify (caller is explicit)

## Implementation plan
### Step 1 — Add option bars volume fetch utilities
**Files:**
- `options_helper/data/alpaca_client.py`

**Work:**
- Add `get_option_bars(symbols: list[str], *, start, end, timeframe) -> pd.DataFrame`
  - return a normalized DataFrame keyed by `contractSymbol` with at least:
    - `volume`
    - `timestamp` (bar time)
- Add chunking logic + backoff on rate limits.

### Step 2 — Join volume into option chain snapshots
**Files:**
- `options_helper/data/providers/alpaca.py`

**Work:**
- In `get_options_chain_raw(...)`:
  - after building the normalized calls/puts rows, collect all `contractSymbol`s
  - fetch option bars (1D) for those symbols over the snapshot_date window
  - join resulting volumes back into rows
- If bar fetch fails, degrade gracefully:
  - keep `volume` as NA, but continue the snapshot

### Step 3 — Regression: BS IV inference improves
**Files:**
- none required (analysis already uses `volume` when present)

**Work:**
- Verify that IV inference improves when last price exists and volume>0.

## Tests
- `tests/providers/test_alpaca_option_volume_join.py` (new)
  - mocked option bars response joined into chain rows correctly
  - missing bars for a symbol results in NA volume (not crash)
- `tests/providers/test_alpaca_recent_bars_buffer.py` (new)
  - verify `effective_end(None)` respects configured buffer minutes

## Acceptance criteria
- Running snapshotter with Alpaca produces `volume` for many liquid contracts.
- On restricted plans, snapshotter avoids “most recent bars” failures by default.
- All failures in volume enrichment are soft (snapshot still completes, and logs a warning).
