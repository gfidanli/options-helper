# IMP-021 — Alpaca provider scaffold + config surface

- **Status:** done
- **Effort:** S
- **Alpha potential:** High

## Summary
Add an **Alpaca** implementation of the existing `MarketDataProvider` abstraction. This IMP wires the official
`alpaca-py` SDK, defines configuration conventions (env vars), and registers the provider behind `--provider alpaca`
without changing analysis code.

This plan intentionally avoids implementing any data endpoints beyond “can import + instantiate + fail helpfully”.

## Goals
- Add `AlpacaProvider` with the same interface as `YahooProvider`.
- Use `alpaca-py` as the SDK for Market Data + Trading endpoints.
- Provide a clear configuration surface (env vars) and good error messages.
- Add a provider-local symbol mapping layer (repo canonical ↔ provider symbols).

## Non-goals
- Fetching candles/options yet (that starts in IMP-022/IMP-024).
- Implementing streaming clients (IMP-029).
- Introducing a new global config system (stick to env + CLI like the current repo).

## User-facing changes
- New CLI option: `--provider alpaca`
- New environment variables (read at runtime):
  - `APCA_API_KEY_ID`
  - `APCA_API_SECRET_KEY`
  - `APCA_API_BASE_URL` (optional; primarily for paper/live trading API; data base is separate)
  - `OH_ALPACA_STOCK_FEED` (optional; e.g. `iex`/`sip`)
  - `OH_ALPACA_OPTIONS_FEED` (optional; e.g. `opra`/`indicative`)
  - `OH_ALPACA_RECENT_BARS_BUFFER_MINUTES` (optional; default 16)

## Design
### SDK usage
Prefer `alpaca-py` clients:
- Market data:
  - `StockHistoricalDataClient`
  - `OptionHistoricalDataClient`
- Trading:
  - `TradingClient` (for option contracts metadata; OI fields)

### Symbol normalization
- Downstream analysis should keep using repo canonical symbols (`BRK-B` style).
- Add two helper functions in the Alpaca integration layer:
  - `to_alpaca_symbol(repo_symbol: str) -> str` (e.g., `BRK-B` → `BRK.B`)
  - `to_repo_symbol(alpaca_symbol: str) -> str` (e.g., `BRK.B` → `BRK-B`)
- Reuse `options_helper.analysis.osi.normalize_underlying` to keep joins stable.

### Dependency management
Two acceptable approaches:
1) **Required dependency:** add `alpaca-py` to `[project].dependencies` (simplest)
2) **Optional extra (recommended):** add `[project.optional-dependencies].alpaca = ["alpaca-py>=..."]`
   and raise a helpful error if the user selects `--provider alpaca` without installing extras.

## Implementation plan
### Step 1 — Add dependency + import guard
**Files:**
- `pyproject.toml`

**Work:**
- Add `alpaca-py` as dependency (required or optional extra).
- In code, guard imports so the repo remains importable even if Alpaca extras aren’t installed.

### Step 2 — Add Alpaca client wrapper
**Files:**
- `options_helper/data/alpaca_client.py` (new)

**Work:**
- Implement `AlpacaClient` that:
  - reads env vars (API keys, feeds)
  - constructs SDK clients lazily (only when a method is called)
  - exposes `.provider_version` via `importlib.metadata.version("alpaca-py")` (best-effort)
- Add `to_alpaca_symbol` / `to_repo_symbol` helpers here (or in a small `symbols.py`).

### Step 3 — Add provider adapter
**Files:**
- `options_helper/data/providers/alpaca.py` (new)
- `options_helper/data/providers/__init__.py`

**Work:**
- Create `AlpacaProvider(MarketDataProvider)`:
  - `name = "alpaca"`
  - delegates to `AlpacaClient`
- Register provider in `_PROVIDERS`:
  - `"alpaca": AlpacaProvider`
- Add aliases:
  - `"apca" → "alpaca"` (optional)
- Ensure `get_provider()` can construct it without a custom client parameter.

### Step 4 — Docs + setup notes
**Files:**
- `README.md` (or `docs/` if preferred)

**Work:**
- Add a short “Alpaca provider setup” section:
  - required env vars
  - plan limitations note (recent bars restriction; OI staleness)
  - example usage: `options-helper --provider alpaca analyze ...`

## Tests
- `tests/test_providers.py`:
  - `get_provider("alpaca")` returns an object with `.name == "alpaca"` **or** raises a clear `DataFetchError`
    indicating missing creds / missing optional dependency.
- New: `tests/providers/test_alpaca_symbols.py`
  - symbol mapping round-trip tests (`BRK-B` ↔ `BRK.B`, `SPY` unchanged).

## Acceptance criteria
- `options-helper --provider alpaca --help` works and provider selection does not crash.
- If `alpaca-py` isn’t installed and the user selects Alpaca, the error message clearly explains how to install it.
- If API keys aren’t set, calling any Alpaca method raises `DataFetchError` with actionable guidance.
