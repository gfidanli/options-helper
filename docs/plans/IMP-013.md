# IMP-013 ‚Äî Quote staleness + data quality scoring

- **Status:** done
- **Effort:** S
- **Alpha potential:** High

## Summary
Yahoo/yfinance option quotes are often stale, missing, or internally inconsistent. Add a lightweight **data quality score** at the contract and report level, and surface it everywhere decisions are made.

## Goals
- Compute a per-contract `quote_quality` object:
  - `spread_pct` (from IMP-001)
  - `has_bid_ask`
  - `has_last`
  - `last_trade_age_days` (best-effort)
  - `liquidity_ok` (volume/OI gates)
  - `score` (0‚Äì100) and `label` (`good/ok/bad/unknown`)
- Bubble up summary stats:
  - % contracts with missing bid/ask
  - worst/median spread_pct
  - count of stale quotes
- Make it easy for downstream outputs to say ‚Äúthis is low-confidence data‚Äù.

## Non-goals
- Fixing Yahoo. üôÇ
- Intraday quote streaming.

## User-facing changes
- Reports and tables gain:
  - `quality` column (label)
  - `spread%` column (if present)
  - `stale` indicator (if last trade age is available)
- New warnings:
  - `quote_stale`
  - `quote_missing_bid_ask`
  - `quote_invalid`

## Design
### Inputs (best-effort)
From option chain rows when present:
- `bid`, `ask`, `lastPrice`
- `volume`, `openInterest`
- `lastTradeDate` (yfinance sometimes provides this)

### Quote quality score (v1)
Keep it simple and explainable. Example scoring (tunable later):
- Start at 100
- If missing bid/ask ‚Üí score = min(score, 40) and label at most `ok`
- If spread_pct is known:
  - `<= 0.15`: no penalty
  - `0.15‚Äì0.35`: -20
  - `> 0.35`: -40
- If lastTradeDate is present:
  - age > 5 trading days: -30 and `quote_stale`
- If volume < min_volume or OI < min_oi: -20

Map score to label:
- `good`: >= 80
- `ok`: 50‚Äì79
- `bad`: < 50
- `unknown`: insufficient fields to score

## Implementation plan
### Step 1 ‚Äî Centralize in a new module
**Files:**
- `options_helper/analysis/quote_quality.py` (new)

**Work:**
- Implement:
  - `compute_quote_quality(df, *, min_volume, min_open_interest) -> pd.DataFrame` returning columns:
    - `spread`, `spread_pct`, `last_trade_age_days`, `quality_score`, `quality_label`, `quality_warnings`
- Reuse spread helpers from `analysis/chain_metrics.py`.

### Step 2 ‚Äî Wire into roll-plan + research
**Files:**
- `options_helper/analysis/roll_plan.py`
- `options_helper/analysis/research.py`

**Work:**
- Add quality label to candidate rows.
- Default behavior: filter out `quality_label == bad` unless the user requests `--include-bad-quotes`.

### Step 3 ‚Äî Wire into analyze/advice
**Files:**
- `options_helper/cli.py`
- `options_helper/analysis/advice.py`

**Work:**
- Add warnings and confidence downgrades when `quality_label` is `bad/unknown`.

### Step 4 ‚Äî Surface in snapshot meta + briefing (optional)
**Files:**
- `options_helper/data/options_snapshotter.py`
- `options_helper/reporting_briefing.py`

**Work:**
- Store snapshot-level quality summary in `meta.json` (e.g., % missing bid/ask).
- Show a short quality line in the briefing per symbol.

## Tests
- Unit tests for `compute_quote_quality` using small synthetic DataFrames.
- CLI tests verifying:
  - quality columns appear
  - bad quotes are filtered by default

## Acceptance criteria
- Users can see when outputs are based on low-quality quotes.
- Default behavior becomes more conservative without breaking workflows.
