# IMP-041 — Derived metrics + Journal → DuckDB

- **Status:** draft
- **Effort:** S–M
- **Alpha potential:** High

## Summary
Move the **DerivedStore** (per-symbol derived metrics) and **JournalStore** (signal_events.jsonl)
to DuckDB-backed implementations, selectable via `--storage duckdb`.

## Goals
- Implement `DuckDBDerivedStore` with `load()` and `upsert()` semantics matching current CSV behavior.
- Implement `DuckDBJournalStore` with `append_events()` / `read_events()` compatible with current JSONL behavior.
- Update store factory to return these stores in DuckDB mode.
- Update CLI call sites to use the store factory (so the backend toggle actually works).

## Non-goals
- Candles migration (IMP-042).
- Options snapshots migration (IMP-043).

## User-facing changes
- None beyond `--storage duckdb` making derived/journal faster and more scalable.
- Output formats remain the same.

## Design
### Tables
- `derived_daily` keyed by `(symbol, date)` with all derived columns as nullable doubles.
- `signal_events` stored as one row per event with JSON payload.

### Compatibility
- Keep the Pydantic `SignalEvent` schema unchanged.
- `DuckDBJournalStore.path()` returns the DuckDB file path so CLI messages remain useful.

## Implementation plan
### Step 1 — DuckDB store implementations
**Files:**
- `options_helper/data/stores_duckdb.py`

**Work:**
- Add `DuckDBDerivedStore`
- Add `DuckDBJournalStore`

### Step 2 — Update store factory routing
**Files:**
- `options_helper/data/store_factory.py`

**Work:**
- Route `get_derived_store()` and `get_journal_store()` to DuckDB stores when enabled.

### Step 3 — Update CLI call sites
**Files:**
- `options_helper/cli.py`

**Work:**
- Replace direct `DerivedStore(...)` / `JournalStore(...)` usage with factory functions.

## Tests
- `test_duckdb_derived_store.py`: upsert + reload returns deterministic rows.
- `test_duckdb_journal_store.py`: append + read roundtrip.

## Acceptance criteria
- All existing derived/journal CLI commands work with `--storage filesystem` and `--storage duckdb`.
- Tests pass offline.
