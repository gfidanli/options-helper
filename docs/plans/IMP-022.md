# IMP-022 — Stocks: candles/history + quote + underlying (Alpaca)

- **Status:** done
- **Effort:** S–M
- **Alpha potential:** High
- **Completed:** 2026-02-04

## Summary
Implement the **stock** parts of `MarketDataProvider` for Alpaca:
- daily candles for CandleStore + backtests
- spot/quote for option selection + reports
- underlying bundle (`UnderlyingData`) for analysis pipelines

This enables most non-options workflows and provides the spot price needed by options chain normalization.

## Goals
- Implement `get_history()` using Alpaca stock bars.
- Implement `get_quote()` using Alpaca latest trade / snapshot.
- Implement `get_underlying()` (history + last_price).
- Normalize outputs to match yfinance conventions used in analysis:
  - OHLCV columns
  - timezone-naive `DatetimeIndex`

## Non-goals
- Intraday quotes/trades stores (IMP-027).
- Corporate actions/news (IMP-028).
- Perfect parity with yfinance for all intervals; v1 supports the intervals the repo actually uses.

## User-facing changes
- Candle cache can now be populated with Alpaca via `--provider alpaca`.
- Spot price comes from Alpaca (often higher quality than Yahoo).

## Design
### Candle semantics
Alpaca stock bars have adjustment modes (raw/split/dividend/all). Map existing repo flags:
- `auto_adjust=True` ⇒ use `adjustment="all"` (splits+dividends)
- `auto_adjust=False` ⇒ use `adjustment="raw"`
- `back_adjust` has no direct Alpaca equivalent; treat it as:
  - either ignored (warn once) or mapped to the same as auto-adjust.

### Interval/timeframe support
Support at least:
- `interval="1d"` (required; CandleStore default)
- `interval="1h"` and `interval="1m"` (optional but useful; make best-effort)

### “Most recent bars” restriction
Some Alpaca plans disallow historical queries into the last ~15 minutes. Standardize:
- if `end` is None: set end = now - buffer_minutes (default 16)
- if `end` is provided: leave it as-is (user is explicit)

The same mitigation will be reused in IMP-025 for option bars.

## Implementation plan
### Step 1 — Add stock bars fetch in `AlpacaClient`
**Files:**
- `options_helper/data/alpaca_client.py`

**Work:**
- `get_stock_bars(symbol, *, start, end, interval, adjustment) -> pd.DataFrame`
- Convert repo interval strings to Alpaca `TimeFrame` values.
- Normalize to a DataFrame with columns:
  - `Open`, `High`, `Low`, `Close`, `Volume`
- Normalize index:
  - `pd.to_datetime(..., utc=True).tz_convert(None)` (timezone-naive)

### Step 2 — Provider methods
**Files:**
- `options_helper/data/providers/alpaca.py`

**Work:**
- Implement `get_history()` by delegating to `AlpacaClient.get_stock_bars(...)`.
- Implement `get_quote()`:
  - Prefer snapshot/latest trade price when available.
  - Fall back to last close from recent bars if needed.
- Implement `get_underlying()`:
  - Use existing CandleStore period parsing by calling `AlpacaProvider.get_history()` via start/end conversion
    (or call Alpaca bars directly using a computed start date).
  - Return `UnderlyingData(symbol=..., last_price=..., history=df)`.

### Step 3 — Basic regression: CandleStore uses provider
**Files:**
- `options_helper/data/candles.py` (no functional changes expected)

**Work:**
- Ensure provider returns schema CandleStore can cache without special-casing.

## Tests
- `tests/test_alpaca_stocks.py` (new)
  - Mock Alpaca SDK response and assert:
    - columns match expected OHLCV naming
    - index is timezone-naive
    - `auto_adjust` mapping uses correct adjustment value
  - Provider-level checks for history/quote/underlying behavior

## Acceptance criteria
- `CandleStore(..., provider=AlpacaProvider())` can cache daily candles for a symbol without crashing.
- `get_quote()` returns a float or `None` (never throws due to missing optional fields).
- `get_underlying()` returns non-empty history for liquid symbols when credentials/data plan allow it.
