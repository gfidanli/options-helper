# IMP-004 — Portfolio-level Greeks + scenario stress

- **Status:** done
- **Effort:** M
- **Alpha potential:** Med–High

## Summary
Add portfolio-level exposure reporting to answer: “what can hurt me fast?” Compute aggregate delta/theta/vega (best-effort) and run simple scenario stresses (spot shocks, vol shocks, time decay) for the current holdings.

This is **risk discipline tooling**, not a trading strategy.

## Goals
- Aggregate Greeks across positions (delta/theta/vega) with clear assumptions.
- Add stress tests:
  - spot +/- X% (user configurable)
  - vol +/- Y IV points
  - time +N days (theta decay)
- Surface as a summary section in `analyze` and in briefing JSON.
- Introduce optional risk_profile thresholds/warnings (e.g., max absolute delta).

## Non-goals
- Portfolio margin calculations.
- Full volatility surface repricing.

## User-facing changes
- New `analyze` summary table:
  - total delta (shares equivalent)
  - total theta/day ($)
  - total vega ($ per 1.00 IV)
  - stress P&L estimates for configured scenarios

## Design
### Inputs
For each position, prefer snapshot/chain greeks when present:
- `delta`, `theta`, `vega` per contract (or per share depending on source)

When missing, approximate with local Black–Scholes using:
- spot (from candle close)
- strike/expiry/type
- implied vol (if present)
- risk-free rate: configurable constant (default 0) to keep it simple

### Units
Be explicit in outputs:
- delta: shares equivalent (`delta * contracts * 100`)
- theta: $/day (`theta_per_day * contracts * 100`) if theta is per share-day
- vega: $ per 1.00 IV (`vega * contracts * 100`)

If sources are ambiguous, store `units` alongside results and keep warnings.

### Stress engine (v1)
For each scenario, reprice each option (BS) and compute portfolio change:
- spot shock: `S' = S * (1 + shock_pct)`
- vol shock: `IV' = max(0, IV + shock_iv)`
- time: reduce DTE by N (floor at 0)

## Implementation plan
### Step 1 — Add a portfolio greeks/stress module
**Files:**
- `options_helper/analysis/portfolio_risk.py` (new)

**Work:**
- Define `PortfolioExposure` and `StressScenario` models.
- Implement:
  - `compute_portfolio_exposure(positions, metrics) -> PortfolioExposure`
  - `run_stress(exposure, scenarios) -> list[StressResult]`

### Step 2 — Wire into `analyze`
**Files:**
- `options_helper/cli.py`

**Work:**
- After per-position metrics, compute portfolio exposure and render a `rich` table.
- Add CLI flags to override scenario parameters:
  - `--stress-spot-pct 0.05` (repeatable)
  - `--stress-vol-pp 5`
  - `--stress-days 7`

### Step 3 — Surface in briefing JSON
**Files:**
- `options_helper/reporting_briefing.py`

**Work:**
- Include the portfolio exposure + stress results in the JSON payload (and optionally a short Markdown section).

### Step 4 — Update docs
**Files:**
- `docs/BRIEFING.md`
- `README.md`

### Step 5 — Tests
**Files:**
- `tests/test_portfolio_greeks.py` (new)

**Work:**
- Use a deterministic small set of synthetic positions.
- Assert computed aggregates and that stress results move in the correct direction.

## Acceptance criteria
- `analyze` prints portfolio Greeks and at least one scenario stress.
- Output clearly labels assumptions and warns when greeks are missing/approximated.
