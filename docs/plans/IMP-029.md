# IMP-029 — Streaming adapters (Alpaca) + optional continuous capture

- **Status:** done
- **Effort:** M–L
- **Alpha potential:** Very High

## Summary
Add optional Alpaca streaming integration so the app can:
- run real-time scanners / alerts
- maintain a continuously updated intraday dataset (more complete than REST polling)
- support “live mode” in future strategies

This IMP builds on (but does not strictly require) the intraday storage layer from IMP-027.

## Goals
- Implement a reusable streaming adapter with handlers for:
  - stock bars/trades/quotes
  - option trades/quotes (and bars if supported)
  - (optional) news stream
- Provide one CLI command to run a stream capture session and persist events.

## Non-goals
- Full live trading automation (separate project scope).
- UI/dashboard work.
- Guaranteeing stream availability on all plans/feeds (degrade gracefully).

## User-facing changes
- New CLI command:
  - `options-helper --provider alpaca stream capture --stocks SPY,AAPL --duration 60 --out-dir data/intraday`
  - Options expansion (from contracts cache): `--options-underlyings SPY --contracts-dir ... --contracts-as-of latest`
  - Feed overrides: `--stock-feed ... --options-feed ...`
- New `scripts/` example for cron-style runs with logging.

## Design
### Alpaca SDK
Use `alpaca-py` websocket clients:
- `StockDataStream` for stock real-time market data
- `OptionDataStream` for options real-time market data
- (optional) news streaming endpoint (either SDK support or raw websocket)
- (optional) `TradingStream` for account events if needed later

### Architecture
- A single `StreamRunner` owns:
  - connection lifecycle
  - subscription management
  - batching/flush to disk
  - backpressure controls
- Handlers should be *pure* (transform event → normalized row dict) and push into an in-memory buffer.
- Flush policy:
  - every N events OR every T seconds
  - write partitioned CSV.gz (reusing `IntradayStore` format)

### Failure modes
- Authentication failures due to missing subscriptions should:
  - log a clear error including the feed name
  - exit non-zero
- Temporary disconnects should:
  - backoff + reconnect
  - keep last written offsets (best effort)

## Shipped implementation
### Modules
- Streaming adapter: `options_helper/data/streaming/alpaca_stream.py`
- Event normalization: `options_helper/data/streaming/normalizers.py`
- Buffered persistence via `IntradayStore`: `options_helper/data/streaming/intraday_writer.py`
- Runner (threads + backoff): `options_helper/data/streaming/runner.py`

### Persistence layout
Partitions are written under `data/intraday/` using the IMP-027 store layout:
- Stocks:
  - `stocks/bars/1Min/<SYMBOL>/<YYYY-MM-DD>.csv.gz`
  - `stocks/quotes/tick/<SYMBOL>/<YYYY-MM-DD>.csv.gz`
  - `stocks/trades/tick/<SYMBOL>/<YYYY-MM-DD>.csv.gz`
- Options:
  - `options/quotes/tick/<CONTRACT>/<YYYY-MM-DD>.csv.gz`
  - `options/trades/tick/<CONTRACT>/<YYYY-MM-DD>.csv.gz`

### Notes / limitations
- `OptionDataStream` in `alpaca-py` does not expose option bars streaming (as of `alpaca-py>=0.43`), so this IMP captures option **trades/quotes** only.
  - Use `options-helper intraday pull-options-bars ...` (IMP-027) for option bars via REST.
- For a short smoke test (~60s), prefer enabling `--quotes` during market hours; 1-minute bars may not arrive in a short window.

## Tests
- Streaming is inherently integration-heavy. Keep unit tests focused:
  - event normalization functions
  - flush/partition logic
  - “reconnect backoff” logic as pure functions (no real websocket)

## Acceptance criteria
- A local run can stream a small list of stock symbols for ~60 seconds and write at least one partition file.
- The process shuts down cleanly on SIGINT, flushing buffered events.
- Options streaming failures (no subscription) produce a helpful message rather than a stack trace.
