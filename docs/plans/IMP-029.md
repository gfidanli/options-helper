# IMP-029 — Streaming adapters (Alpaca) + optional continuous capture

- **Status:** draft
- **Effort:** M–L
- **Alpha potential:** Very High

## Summary
Add optional Alpaca streaming integration so the app can:
- run real-time scanners / alerts
- maintain a continuously updated intraday dataset (more complete than REST polling)
- support “live mode” in future strategies

This IMP builds on (but does not strictly require) the intraday storage layer from IMP-027.

## Goals
- Implement a reusable streaming adapter with handlers for:
  - stock bars/trades/quotes
  - option trades/quotes (and bars if supported)
  - (optional) news stream
- Provide one CLI command to run a stream capture session and persist events.

## Non-goals
- Full live trading automation (separate project scope).
- UI/dashboard work.
- Guaranteeing stream availability on all plans/feeds (degrade gracefully).

## User-facing changes
- New CLI command (proposed):
  - `options-helper stream capture --stocks SPY,AAPL --options-underlyings SPY --feeds ... --out data/intraday/...`
- New `scripts/` example for running as a long-lived process with logging.

## Design
### Alpaca SDK
Use `alpaca-py` websocket clients:
- `StockDataStream` for stock real-time market data
- `OptionDataStream` for options real-time market data
- (optional) news streaming endpoint (either SDK support or raw websocket)
- (optional) `TradingStream` for account events if needed later

### Architecture
- A single `StreamRunner` owns:
  - connection lifecycle
  - subscription management
  - batching/flush to disk
  - backpressure controls
- Handlers should be *pure* (transform event → normalized row dict) and push into an in-memory buffer.
- Flush policy:
  - every N events OR every T seconds
  - write partitioned CSV.gz (reusing `IntradayStore` format)

### Failure modes
- Authentication failures due to missing subscriptions should:
  - log a clear error including the feed name
  - exit non-zero
- Temporary disconnects should:
  - backoff + reconnect
  - keep last written offsets (best effort)

## Implementation plan
### Step 1 — Streaming adapter module
**Files:**
- `options_helper/data/streaming/alpaca_stream.py` (new)

**Work:**
- Implement:
  - `AlpacaStockStreamer`
  - `AlpacaOptionStreamer`
  - Each takes handlers for bars/trades/quotes and manages subscribe/unsubscribe.

### Step 2 — Normalization + persistence
**Files:**
- `options_helper/data/intraday_store.py` (from IMP-027)
- `options_helper/data/streaming/normalizers.py` (new)

**Work:**
- Normalize event objects/dicts to the same schemas as IMP-027.
- Append to per-day partitions (rotate when date changes in exchange timezone).

### Step 3 — CLI: capture session
**Files:**
- `options_helper/cli.py`

**Work:**
- Add `stream capture` command:
  - parse symbols, feeds, output dir
  - run asyncio loop to start streams and flush partitions

### Step 4 — Operational script
**Files:**
- `scripts/cron_stream_capture.sh` (new, optional)

**Work:**
- Example of running streaming capture during market hours.

## Tests
- Streaming is inherently integration-heavy. Keep unit tests focused:
  - event normalization functions
  - flush/partition logic
  - “reconnect backoff” logic as pure functions (no real websocket)

## Acceptance criteria
- A local run can stream a small list of stock symbols for ~60 seconds and write at least one partition file.
- The process shuts down cleanly on SIGINT, flushing buffered events.
- Options streaming failures (no subscription) produce a helpful message rather than a stack trace.
